# KTSP 项目开发规范

> 本规范适用于 KTSP 预约系统及后续衍生项目，确保代码质量、可维护性和复用性。

---

## 一、核心原则

### 1. 模块组件化
- 每个功能模块独立成子系统
- 组件职责单一，一个组件只做一件事
- 页面只负责布局和组合组件，不包含业务逻辑

### 2. 配置化驱动
- 所有文案、规则、参数放入配置文件
- 新项目只需修改 `src/config/modules/` 下的配置文件
- 配置文件命名规范：`{模块名}.config.ts`

### 3. 低耦合高内聚
- 组件只通过 props 接收数据，不直接依赖外部状态
- Hook 封装数据获取和状态管理
- 模块之间通过 API 通信，避免直接引用

### 4. 可复用可迁移
- 每个子系统可独立运行
- 后续项目复用只需：修改配置 + 替换数据库

---

## 二、目录结构规范

```
src/
├── app/                    # Next.js App Router
│   ├── (main)/            # 主布局页面组
│   │   ├── page.tsx       # 首页
│   │   ├── venues/        # 场地模块
│   │   ├── checkin/       # 签到模块
│   │   └── feedback/      # 反馈模块
│   └── api/               # API 路由
│       ├── venues/        # 场地 API
│       ├── checkin/       # 签到 API
│       └── home/          # 首页 API
├── components/            # 组件
│   ├── ui/               # 基础 UI 组件（shadcn/ui）
│   ├── home/             # 首页组件
│   ├── venue/            # 场地组件
│   ├── checkin/          # 签到组件
│   └── {module}/         # 其他模块组件
├── config/               # 配置中心
│   ├── index.ts          # 统一导出
│   └── modules/          # 各模块配置
│       ├── home.config.ts
│       ├── venue.config.ts
│       └── checkin.config.ts
├── hooks/                # 自定义 Hooks
│   ├── use-home.ts
│   ├── use-venue.ts
│   └── use-checkin.ts
├── lib/                  # 工具库
│   ├── api.ts           # API 请求封装
│   ├── db.ts            # 数据库连接
│   ├── response.ts      # 统一响应格式
│   └── utils.ts         # 通用工具函数
└── types/               # 类型定义
```

---

## 三、组件开发规范

### 1. 文件命名
- 组件文件：`PascalCase.tsx`（如 `VenueCard.tsx`）
- Hook 文件：`use-{name}.ts`（如 `use-venue.ts`）
- 配置文件：`{name}.config.ts`（如 `venue.config.ts`）

### 2. 组件结构
```tsx
"use client";

import { ... } from "react";
import { ... } from "@/components/ui";
import { xxxConfig } from "@/config";

// 类型定义
interface ComponentProps {
  // ...
}

/**
 * 组件说明
 * 
 * 【职责】描述组件职责
 * 【配置化】说明可配置项
 */
export function ComponentName({ prop1, prop2 }: ComponentProps) {
  // 逻辑
  return (
    // JSX
  );
}
```

### 3. 组件导出
每个模块必须有 `index.ts` 统一导出：
```ts
// src/components/venue/index.ts
export { VenueCard } from "./VenueCard";
export { VenueList } from "./VenueList";
export { TimeSlotPicker } from "./TimeSlotPicker";
```

---

## 四、Hook 开发规范

### 1. 命名规则
- 数据获取：`use{Module}` / `use{Module}List` / `use{Module}Detail`
- 配置获取：`use{Module}Config`

### 2. 标准结构
```ts
"use client";

import { useState, useEffect, useCallback, useMemo } from "react";
import { get } from "@/lib/api";
import { xxxConfig } from "@/config";

export function useXxx() {
  const [loading, setLoading] = useState(true);
  const [error, setError] = useState<string | null>(null);
  const [data, setData] = useState<T | null>(null);

  const fetchData = useCallback(async () => {
    try {
      setLoading(true);
      setError(null);
      const result = await get<T>("/api/xxx");
      setData(result);
    } catch (err) {
      console.error("获取数据失败:", err);
      setError("加载失败，请刷新重试");
    } finally {
      setLoading(false);
    }
  }, []);

  useEffect(() => {
    fetchData();
  }, [fetchData]);

  return { loading, error, data, refresh: fetchData };
}
```

### 3. 性能优化
- 计算结果用 `useMemo`
- 回调函数用 `useCallback`
- 避免在渲染时创建新对象/数组

---

## 五、API 开发规范

### 1. 路由结构
```
api/
├── {module}/
│   ├── route.ts           # GET 列表 / POST 创建
│   └── [id]/
│       ├── route.ts       # GET 详情 / PUT 更新 / DELETE 删除
│       └── {action}/      # 特定操作
│           └── route.ts
```

### 2. 统一响应格式
```ts
// 成功
{
  "success": true,
  "data": { ... }
}

// 失败
{
  "success": false,
  "error": {
    "code": "ERROR_CODE",
    "message": "错误信息"
  }
}
```

### 3. 标准模板
```ts
import { NextRequest } from "next/server";
import { prisma } from "@/lib/db";
import { success, Errors } from "@/lib/response";

export async function GET(request: NextRequest) {
  try {
    // 1. 参数校验
    // 2. 权限验证
    // 3. 业务逻辑
    // 4. 返回结果
    return success(data);
  } catch (error) {
    console.error("操作失败:", error);
    return Errors.INTERNAL_ERROR();
  }
}
```

---

## 六、配置文件规范

### 1. 标准结构
```ts
/**
 * {模块名}子系统配置
 * 
 * 【复用说明】
 * 新项目只需修改此文件，无需改代码
 */
export const xxxConfig = {
  // ==================== 页面文字 ====================
  texts: {
    pageTitle: "页面标题",
    emptyText: "暂无数据",
    // ...
  },
  
  // ==================== 业务规则 ====================
  rules: {
    maxCount: 10,
    minLength: 5,
    // ...
  },
  
  // ==================== 类型/选项 ====================
  types: [
    { key: "type1", label: "类型1", icon: "icon1" },
    // ...
  ],
};

export type XxxConfig = typeof xxxConfig;
```

---

## 七、代码质量检查清单

### 提交前必检
- [ ] TypeScript 编译无错误（`npx tsc --noEmit`）
- [ ] ESLint 无错误（`npx eslint src`）
- [ ] 无未使用的导入/变量
- [ ] 无 `any` 类型（除非必要）
- [ ] 组件有导出文件 `index.ts`
- [ ] Hook 使用 `useMemo`/`useCallback` 优化
- [ ] API 有错误处理和日志

### 规范检查
- [ ] 配置与代码分离
- [ ] 组件职责单一
- [ ] 无硬编码文案
- [ ] 无重复代码

---

## 八、Git 提交规范

### Commit Message 格式
```
<type>(<scope>): <subject>

<body>
```

### Type 类型
| 类型 | 说明 |
|------|------|
| feat | 新功能 |
| fix | 修复 Bug |
| docs | 文档更新 |
| style | 代码格式（不影响功能） |
| refactor | 重构 |
| perf | 性能优化 |
| test | 测试 |
| chore | 构建/工具 |

### 示例
```
feat(venue): 添加场地预约模块

- 创建 VenueCard、VenueList 组件
- 添加场地列表/详情 API
- 添加 useVenue Hook
```

---

## 九、模块开发流程

1. **创建配置文件** → `src/config/modules/{module}.config.ts`
2. **创建组件** → `src/components/{module}/`
3. **创建 API** → `src/app/api/{module}/`
4. **创建 Hook** → `src/hooks/use-{module}.ts`
5. **创建页面** → `src/app/(main)/{module}/page.tsx`
6. **代码检查** → TypeScript + ESLint
7. **测试验证** → 功能测试

---

**遵循以上规范，确保项目可维护、可复用、高质量！**
