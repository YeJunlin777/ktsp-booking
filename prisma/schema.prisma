// KTSP 预订系统数据库 Schema
// 使用 Prisma ORM + MySQL

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mysql"
}

// ==================== 用户相关 ====================

// 用户表
model User {
  id            String    @id @default(cuid())
  phone         String?   @unique          // 手机号
  email         String?   @unique          // 邮箱（第三方登录）
  name          String?                    // 姓名
  nickname      String?                    // 昵称
  avatar        String?                    // 头像URL
  password      String?                    // 密码（加密）
  
  // 会员信息
  memberLevel   String    @default("普通会员")  // 会员等级
  points        Int       @default(0)           // 积分余额
  
  // 实名认证
  realName      String?                    // 真实姓名
  idCard        String?                    // 身份证号
  idCardFront   String?                    // 身份证正面照
  idCardBack    String?                    // 身份证反面照
  verifyStatus  String    @default("未认证")   // 认证状态：未认证/待审核/已认证/已拒绝
  
  // 邀请相关
  inviteCode    String?   @unique          // 我的邀请码
  invitedBy     String?                    // 邀请我的人ID
  
  // 状态
  status        String    @default("active")   // active/disabled
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  
  // 关联
  accounts      Account[]
  sessions      Session[]
  bookings      Booking[]
  checkins      Checkin[]
  pointLogs     PointLog[]
  messages      Message[]
  feedbacks     Feedback[]
  reviews       Review[]
  
  @@map("users")
}

// OAuth账号（Apple/Google登录）
model Account {
  id                String  @id @default(cuid())
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String? @db.Text
  access_token      String? @db.Text
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String? @db.Text
  session_state     String?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
  @@map("accounts")
}

// 会话
model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("sessions")
}

// 验证Token
model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
  @@map("verification_tokens")
}

// ==================== 场地相关 ====================

// 场地/打位
model Venue {
  id          String   @id @default(cuid())
  name        String                       // 场地名称
  type        String                       // 类型：driving_range/simulator/putting_green/vip_room
  description String?  @db.Text            // 描述
  images      Json?                        // 图片数组 JSON
  capacity    Int      @default(1)         // 容量
  
  // 价格
  price       Decimal  @db.Decimal(10, 2)  // 基础价格
  peakPrice   Decimal? @db.Decimal(10, 2)  // 高峰价格
  
  // 设施和营业时间
  facilities  Json?                        // 设施 JSON数组
  openTime    String   @default("06:00")   // 营业开始时间
  closeTime   String   @default("22:00")   // 营业结束时间
  minDuration Int      @default(15)        // 最小预约时长（分钟）- 支持15/30/60分钟
  maxDuration Int      @default(240)       // 最大预约时长（分钟）
  
  status      String   @default("active")  // active/maintenance/disabled
  sortOrder   Int      @default(0)         // 排序
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  timeSlots   TimeSlot[]
  bookings    Booking[]
  reviews     Review[]
  
  @@map("venues")
}

// 时段模板
model TimeSlot {
  id        String   @id @default(cuid())
  venueId   String
  dayOfWeek Int                          // 0-6 周日到周六
  startTime String                       // 开始时间 HH:mm
  endTime   String                       // 结束时间 HH:mm
  price     Decimal  @db.Decimal(10, 2)  // 价格
  isHoliday Boolean  @default(false)     // 是否节假日价格
  status    String   @default("active")
  
  venue     Venue    @relation(fields: [venueId], references: [id])
  
  @@map("time_slots")
}

// ==================== 预约相关 ====================

// 预约订单
model Booking {
  id            String   @id @default(cuid())
  orderNo       String   @unique              // 订单号
  userId        String
  venueId       String?
  coachId       String?
  courseId      String?
  
  bookingType   String                        // venue/coach/course
  bookingDate   DateTime                      // 预约日期
  startTime     String                        // 开始时间
  endTime       String                        // 结束时间
  
  // 价格
  originalPrice Decimal  @db.Decimal(10, 2)   // 原价
  discountPrice Decimal? @db.Decimal(10, 2)   // 折扣价
  finalPrice    Decimal  @db.Decimal(10, 2)   // 最终价格
  couponCode    String?                       // 使用的优惠码
  
  // 多人预约
  playerCount   Int      @default(1)          // 人数
  players       Json?                         // 同行人信息
  
  // 状态
  status        String   @default("pending")  // pending/confirmed/completed/cancelled/no_show
  cancelReason  String?
  
  // 乐观锁
  version       Int      @default(0)
  
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  
  user          User     @relation(fields: [userId], references: [id])
  venue         Venue?   @relation(fields: [venueId], references: [id])
  coach         Coach?   @relation(fields: [coachId], references: [id])
  course        Course?  @relation(fields: [courseId], references: [id])
  reviews       Review[]
  
  @@index([userId])
  @@index([venueId])
  @@index([bookingDate])
  @@index([status])
  @@map("bookings")
}

// ==================== 教练相关 ====================

// 教练
model Coach {
  id             String   @id @default(cuid())
  name           String
  avatar         String?
  title          String?                      // 头衔
  introduction   String?  @db.Text            // 简介
  specialty      Json?                        // 擅长领域 JSON数组
  certifications Json?                        // 证书 JSON数组
  experience     Int      @default(1)         // 教学经验（年）
  price          Decimal  @db.Decimal(10, 2)  // 课时费
  rating         Decimal  @default(5.0) @db.Decimal(2, 1)  // 评分
  reviewCount    Int      @default(0)         // 评价数
  lessonCount    Int      @default(0)         // 授课数
  status         String   @default("active")
  sortOrder      Int      @default(0)
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt
  
  schedules   CoachSchedule[]
  bookings    Booking[]
  reviews     Review[]
  
  @@map("coaches")
}

// 教练排班
model CoachSchedule {
  id        String   @id @default(cuid())
  coachId   String
  date      DateTime                      // 日期
  startTime String                        // 开始时间
  endTime   String                        // 结束时间
  isBooked  Boolean  @default(false)      // 是否已被预约
  
  coach     Coach    @relation(fields: [coachId], references: [id])
  
  @@index([coachId, date])
  @@map("coach_schedules")
}

// ==================== 团体课程 ====================

// 团体课程
model Course {
  id             String    @id @default(cuid())
  name           String
  description    String?   @db.Text
  image          String?
  category       String?                      // 分类：short_game/long_game/youth/beginner
  coachId        String?                      // 授课教练ID
  coachName      String?                      // 授课教练名（冗余）
  syllabus       Json?                        // 课程大纲 JSON
  totalLessons   Int       @default(1)        // 总课时数
  maxStudents    Int                          // 最大人数
  enrolled       Int       @default(0)        // 已报名人数
  price          Decimal   @db.Decimal(10, 2)
  startDate      DateTime
  endDate        DateTime
  enrollDeadline DateTime?                    // 报名截止日期
  schedule       String?                      // 上课时间描述
  requirements   String?   @db.Text           // 报名要求
  status         String    @default("active") // active/enrolling/full/ended
  createdAt      DateTime  @default(now())
  updatedAt      DateTime  @updatedAt
  
  bookings    Booking[]
  
  @@map("courses")
}

// ==================== 积分相关 ====================

// 签到记录
model Checkin {
  id           String   @id @default(cuid())
  userId       String
  checkinDate  DateTime                    // 签到日期
  points       Int                         // 获得积分
  streakDays   Int      @default(1)        // 连续签到天数
  createdAt    DateTime @default(now())
  
  user         User     @relation(fields: [userId], references: [id])
  
  @@unique([userId, checkinDate])
  @@map("checkins")
}

// 积分流水
model PointLog {
  id        String   @id @default(cuid())
  userId    String
  type      String                        // checkin/booking/redeem/invite/admin
  points    Int                           // 正数增加，负数减少
  balance   Int                           // 变动后余额
  remark    String?
  relatedId String?                       // 关联ID（订单ID等）
  createdAt DateTime @default(now())
  
  user      User     @relation(fields: [userId], references: [id])
  
  @@index([userId])
  @@map("point_logs")
}

// ==================== 积分商城 ====================

// 积分商品
model Product {
  id              String   @id @default(cuid())
  name            String
  description     String?  @db.Text
  images          Json?                        // 图片数组 JSON
  points          Int                          // 所需积分
  originalPoints  Int?                         // 原价积分（用于显示折扣）
  stock           Int      @default(0)         // 库存
  category        String   @default("goods")   // goods/virtual/coupon
  deliveryMethod  String   @default("pickup")  // pickup/delivery
  specifications  Json?                        // 规格参数 JSON
  salesCount      Int      @default(0)         // 销量
  status          String   @default("active")
  sortOrder       Int      @default(0)
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  
  orders      ProductOrder[]
  
  @@map("products")
}

// 积分兑换订单
model ProductOrder {
  id          String   @id @default(cuid())
  orderNo     String   @unique
  userId      String
  productId   String
  productName String                       // 冗余商品名
  points      Int                          // 消耗积分
  quantity    Int      @default(1)
  status      String   @default("pending") // pending/confirmed/shipped/completed
  address     String?  @db.Text            // 收货地址JSON
  remark      String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  product     Product  @relation(fields: [productId], references: [id])
  
  @@map("product_orders")
}

// ==================== 优惠券系统 ====================

// 优惠券模板（管理员创建）
model CouponTemplate {
  id              String    @id @default(cuid())
  name            String                       // 券名称
  type            String                       // amount/discount 固定金额/折扣
  value           Decimal   @db.Decimal(10, 2) // 金额或折扣率
  minAmount       Decimal?  @db.Decimal(10, 2) // 最低消费
  maxDiscount     Decimal?  @db.Decimal(10, 2) // 最大优惠金额（折扣券用）
  applicableTypes Json?                        // 适用场地类型 JSON数组
  totalQuantity   Int?                         // 发行总量（null=无限）
  claimedCount    Int       @default(0)        // 已领取数量
  perUserLimit    Int       @default(1)        // 每人限领数量
  startDate       DateTime?                    // 生效开始日期
  endDate         DateTime?                    // 生效结束日期
  validDays       Int?                         // 领取后有效天数
  isPublic        Boolean   @default(true)     // 是否公开领取
  status          String    @default("active")
  createdAt       DateTime  @default(now())
  
  userCoupons     UserCoupon[]
  
  @@map("coupon_templates")
}

// 用户优惠券（用户领取的）
model UserCoupon {
  id          String    @id @default(cuid())
  userId      String
  templateId  String
  code        String    @unique              // 券码（唯一）
  status      String    @default("available") // available/used/expired
  usedAt      DateTime?                       // 使用时间
  usedOrderId String?                         // 使用的订单ID
  expireAt    DateTime                        // 过期时间
  createdAt   DateTime  @default(now())
  
  template    CouponTemplate @relation(fields: [templateId], references: [id])
  
  @@index([userId])
  @@index([status])
  @@map("user_coupons")
}

// 旧优惠码（兼容直接输入优惠码场景）
model Coupon {
  id          String    @id @default(cuid())
  code        String    @unique            // 优惠码
  type        String                       // fixed/percent 固定金额/折扣
  value       Decimal   @db.Decimal(10, 2) // 金额或折扣率
  minAmount   Decimal?  @db.Decimal(10, 2) // 最低消费
  maxDiscount Decimal?  @db.Decimal(10, 2) // 最大优惠金额
  usageLimit  Int?                         // 使用次数限制
  usedCount   Int       @default(0)        // 已使用次数
  startDate   DateTime?
  endDate     DateTime?
  status      String    @default("active")
  createdAt   DateTime  @default(now())
  
  @@map("coupons")
}

// ==================== 消息 ====================

model Message {
  id        String   @id @default(cuid())
  userId    String
  title     String
  content   String   @db.Text
  type      String   @default("system")   // system/booking/points/promo
  isRead    Boolean  @default(false)
  createdAt DateTime @default(now())
  
  user      User     @relation(fields: [userId], references: [id])
  
  @@index([userId])
  @@map("messages")
}

// ==================== 评价 ====================

model Review {
  id           String   @id @default(cuid())
  userId       String
  bookingId    String
  venueId      String?                      // 评价的场地
  coachId      String?                      // 评价的教练
  venueRating  Int?                         // 场地评分 1-5
  venueComment String?  @db.Text            // 场地评价
  coachRating  Int?                         // 教练评分 1-5
  coachComment String?  @db.Text            // 教练评价
  images       Json?                        // 图片数组
  createdAt    DateTime @default(now())
  
  user      User     @relation(fields: [userId], references: [id])
  booking   Booking  @relation(fields: [bookingId], references: [id])
  venue     Venue?   @relation(fields: [venueId], references: [id])
  coach     Coach?   @relation(fields: [coachId], references: [id])
  
  @@map("reviews")
}

// ==================== 反馈 ====================

model Feedback {
  id        String   @id @default(cuid())
  userId    String
  type      String                        // suggestion/complaint/bug
  content   String   @db.Text
  images    Json?
  status    String   @default("pending")  // pending/processing/resolved
  reply     String?  @db.Text
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  user      User     @relation(fields: [userId], references: [id])
  
  @@map("feedbacks")
}

// ==================== 管理员 ====================

model Admin {
  id        String   @id @default(cuid())
  username  String   @unique
  password  String
  name      String
  role      String   @default("staff")    // admin/staff
  status    String   @default("active")
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  @@map("admins")
}

// ==================== 系统配置 ====================

model Setting {
  id        String   @id @default(cuid())
  key       String   @unique
  value     String   @db.Text
  remark    String?
  updatedAt DateTime @updatedAt
  
  @@map("settings")
}

// 轮播图
model Banner {
  id        String   @id @default(cuid())
  title     String?
  image     String
  link      String?
  sortOrder Int      @default(0)
  status    String   @default("active")
  createdAt DateTime @default(now())
  
  @@map("banners")
}

// 节假日设置
model Holiday {
  id        String   @id @default(cuid())
  date      DateTime @unique             // 节假日日期
  name      String                       // 节日名称
  type      String   @default("holiday") // holiday/workday（调休上班）
  createdAt DateTime @default(now())
  
  @@map("holidays")
}

// ==================== 黑名单 ====================

model Blacklist {
  id        String   @id @default(cuid())
  userId    String   @unique
  reason    String?  @db.Text            // 拉黑原因
  createdBy String?                      // 操作人ID
  createdAt DateTime @default(now())
  
  @@map("blacklist")
}

// ==================== 预约邀请（多人联机） ====================

model BookingInvitation {
  id          String    @id @default(cuid())
  bookingId   String                        // 预约ID
  inviterId   String                        // 邀请人ID
  inviteeId   String?                       // 被邀请人ID（已注册用户）
  invitePhone String?                       // 被邀请人手机号（未注册）
  status      String    @default("pending") // pending/accepted/rejected/expired
  respondedAt DateTime?                     // 响应时间
  createdAt   DateTime  @default(now())
  
  @@index([bookingId])
  @@index([inviteeId])
  @@map("booking_invitations")
}

// ==================== 推荐有礼 ====================

model ReferralRecord {
  id          String    @id @default(cuid())
  inviterId   String                        // 邀请人ID
  inviteeId   String                        // 被邀请人ID
  status      String    @default("pending") // pending/completed（首次消费后完成）
  inviterReward Int     @default(0)         // 邀请人获得积分
  inviteeReward Int     @default(0)         // 被邀请人获得积分
  completedAt DateTime?                     // 完成时间
  createdAt   DateTime  @default(now())
  
  @@unique([inviterId, inviteeId])
  @@index([inviterId])
  @@map("referral_records")
}

// ==================== 积分任务 ====================

model PointTask {
  id          String   @id @default(cuid())
  key         String   @unique             // 任务标识
  name        String                       // 任务名称
  description String?                      // 任务描述
  points      Int                          // 奖励积分
  type        String   @default("once")    // once/daily/unlimited
  dailyLimit  Int?                         // 每日完成次数限制
  icon        String?                      // 图标
  sortOrder   Int      @default(0)
  status      String   @default("active")
  
  completions PointTaskCompletion[]
  
  @@map("point_tasks")
}

// 用户任务完成记录
model PointTaskCompletion {
  id        String   @id @default(cuid())
  userId    String
  taskId    String
  points    Int                           // 获得积分
  createdAt DateTime @default(now())
  
  task      PointTask @relation(fields: [taskId], references: [id])
  
  @@index([userId, taskId])
  @@map("point_task_completions")
}
